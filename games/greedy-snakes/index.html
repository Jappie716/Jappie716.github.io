<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Greedy Snake - Cloud Sync</title>
<link rel="stylesheet" href="style.css" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
.auth-bar {
  position: fixed;
  top: 10px;
  right: 70px;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 10px;
}
#loginBtn {
  padding: 5px 12px;
  background: #4285F4;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
#userDisplay {
  color: white;
  font-family: sans-serif;
  font-size: 13px;
}
#cloudStatus {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.8);
  color: #00ffcc;
  padding: 6px 12px;
  border-radius: 20px;
  font-family: monospace;
  font-size: 12px;
  z-index: 9999;
}
</style>
</head>
<script>
/* =========================
   FIREBASE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
  authDomain: "gameparadise-80490.firebaseapp.com",
  projectId: "gameparadise-80490",
  storageBucket: "gameparadise-80490.firebasestorage.app",
  messagingSenderId: "335620903527",
  appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let lastSaveHash = null;

/* =========================
   LOGIN
========================= */
auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  if (!user) return;

  console.log("‚òÅÔ∏è Cloud login:", user.email);
  await loadGreedyState();
});

/* =========================
   GAME STATE READER
========================= */
function getGameState() {
  return {
    playerName: document.getElementById("playerName")?.value || "",
    yellowMoney: window.yellowMoney || 0,
    greenMoney: window.greenMoney || 0,
    sizeLevel: window.sizeLevel || 1,
    speedLevel: window.speedLevel || 1,
    multiplierLevel: window.multiplierLevel || 1,
    selectedSkin: window.selectedSkin || 0
  };
}

function hashState(state) {
  return JSON.stringify(state);
}

/* =========================
   SAVE
========================= */
async function saveGreedyState() {
  if (!currentUser) return;

  const state = getGameState();
  const hash = hashState(state);

  // Niet opnieuw saven als er niks veranderd is
  if (hash === lastSaveHash) return;
  lastSaveHash = hash;

  try {
    await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("games")
      .doc("greedySnakes")
      .set(
        {
          ...state,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        },
        { merge: true }
      );

    console.log("üíæ Cloud saved");
  } catch (e) {
    console.error("Cloud save error:", e);
  }
}

/* =========================
   LOAD
========================= */
async function loadGreedyState() {
  try {
    const doc = await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("games")
      .doc("greedySnakes")
      .get();

    if (!doc.exists) return;

    const data = doc.data();
    console.log("‚òÅÔ∏è Cloud loaded:", data);

    // Inject in globals (werkt ook als game.js ze later overschrijft)
    window.yellowMoney = data.yellowMoney || 0;
    window.greenMoney = data.greenMoney || 0;
    window.sizeLevel = data.sizeLevel || 1;
    window.speedLevel = data.speedLevel || 1;
    window.multiplierLevel = data.multiplierLevel || 1;
    window.selectedSkin = data.selectedSkin || 0;

    if (data.playerName && document.getElementById("playerName")) {
      document.getElementById("playerName").value = data.playerName;
    }

    // UI refresh proberen
    if (typeof window.refreshUI === "function") {
      window.refreshUI();
    }
  } catch (e) {
    console.error("Cloud load error:", e);
  }
}

/* =========================
   AUTO DETECT CHANGES
========================= */
function hookVar(name) {
  let value = window[name];

  Object.defineProperty(window, name, {
    get() {
      return value;
    },
    set(v) {
      value = v;
      saveGreedyState();
    },
    configurable: true
  });
}

/* =========================
   WAIT FOR GAME GLOBALS
========================= */
const hookTimer = setInterval(() => {
  if (
    "yellowMoney" in window &&
    "greenMoney" in window &&
    "sizeLevel" in window
  ) {
    console.log("ü™ù Cloud hooks actief");
    hookVar("yellowMoney");
    hookVar("greenMoney");
    hookVar("sizeLevel");
    hookVar("speedLevel");
    hookVar("multiplierLevel");
    hookVar("selectedSkin");
    clearInterval(hookTimer);
  }
}, 500);

/* =========================
   BACKUP AUTOSAVE
========================= */
setInterval(saveGreedyState, 15000);
window.addEventListener("beforeunload", saveGreedyState);
document.addEventListener("click", saveGreedyState);
</script>

<body>

<script src="game.js"></script>
</body>
</html>
