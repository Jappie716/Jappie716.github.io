<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Greedy Snake - Cloud Sync</title>
<link rel="stylesheet" href="style.css" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
.auth-bar {
  position: fixed;
  top: 10px;
  right: 70px;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 10px;
}
#loginBtn {
  padding: 5px 12px;
  background: #4285F4;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
#userDisplay {
  color: white;
  font-family: sans-serif;
  font-size: 13px;
}
#cloudStatus {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.8);
  color: #00ffcc;
  padding: 6px 12px;
  border-radius: 20px;
  font-family: monospace;
  font-size: 12px;
  z-index: 9999;
}
</style>
</head>

<body>

<div id="cloudStatus">‚òÅÔ∏è Cloud: idle</div>

<div class="auth-bar">
  <span id="userDisplay"></span>
  <button id="loginBtn">Login with Google</button>
</div>

<!-- GAME HTML BLIJFT ONGEWIJZIGD -->
<!-- (alles wat je stuurde hierboven blijft exact hetzelfde) -->

<script>
/* =============================
   FIREBASE CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
  authDomain: "gameparadise-80490.firebaseapp.com",
  projectId: "gameparadise-80490",
  storageBucket: "gameparadise-80490.firebasestorage.app",
  messagingSenderId: "335620903527",
  appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
const cloudStatus = document.getElementById("cloudStatus");

/* =============================
   LOGIN
============================= */
document.getElementById("loginBtn").onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

auth.onAuthStateChanged(async (user) => {
  currentUser = user;

  if (!user) {
    cloudStatus.textContent = "‚ö†Ô∏è Niet ingelogd";
    return;
  }

  document.getElementById("loginBtn").style.display = "none";
  document.getElementById("userDisplay").innerText =
    "Player: " + user.displayName.split(" ")[0];

  cloudStatus.textContent = "‚òÅÔ∏è Cloud laden...";
  await loadUserData();
});

/* =============================
   PROFILE SAVE
============================= */
function saveUsername(name) {
  if (!currentUser) return;

  return db
    .collection("users")
    .doc(currentUser.uid)
    .collection("profile")
    .doc("main")
    .set(
      {
        username: name,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      { merge: true }
    );
}

/* =============================
   GAME SAVE
============================= */
function saveGreedyState(state) {
  if (!currentUser) return;

  cloudStatus.textContent = "üíæ Cloud opslaan...";

  return db
    .collection("users")
    .doc(currentUser.uid)
    .collection("games")
    .doc("greedySnakes")
    .set(
      {
        ...state,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      { merge: true }
    )
    .then(() => {
      cloudStatus.textContent = "‚úÖ Cloud gesynct";
    })
    .catch(() => {
      cloudStatus.textContent = "‚ùå Cloud fout";
    });
}

/* =============================
   LOAD USER DATA
============================= */
async function loadUserData() {
  if (!currentUser) return;

  try {
    // PROFILE
    const profileDoc = await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("profile")
      .doc("main")
      .get();

    if (profileDoc.exists) {
      const name = profileDoc.data().username;
      if (name && document.getElementById("playerName")) {
        document.getElementById("playerName").value = name;
      }
    }

    // GAME SAVE
    const gameDoc = await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("games")
      .doc("greedySnakes")
      .get();

    if (gameDoc.exists && window.applyLoadedState) {
      window.applyLoadedState(gameDoc.data());
      cloudStatus.textContent = "‚òÅÔ∏è Cloud geladen";
    } else {
      cloudStatus.textContent = "üÜï Nieuwe save";
    }
  } catch (e) {
    cloudStatus.textContent = "‚ùå Cloud fout";
    console.error(e);
  }
}

/* =============================
   AUTO SAVE SYSTEM
============================= */
function autoSave() {
  if (!currentUser || !window.getCurrentState) return;

  const state = window.getCurrentState();

  saveUsername(state.playerName);
  saveGreedyState(state);
}

// Elke 20 seconden opslaan
setInterval(autoSave, 20000);

// Save bij sluiten / refresh
window.addEventListener("beforeunload", autoSave);

// Save bij game start
const _startGameHook = window.startGame;
window.startGame = function () {
  autoSave();
  return _startGameHook();
};
</script>

<script src="game.js"></script>
</body>
</html>
