<script>
/* =====================
   FIREBASE
===================== */
const firebaseConfig = {
  apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
  authDomain: "gameparadise-80490.firebaseapp.com",
  projectId: "gameparadise-80490",
  storageBucket: "gameparadise-80490.firebasestorage.app",
  messagingSenderId: "335620903527",
  appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

/* =====================
   AUTH
===================== */
auth.onAuthStateChanged(user => {
  if (!user) return;
  currentUser = user;
  console.log("ðŸ” Logged in:", user.uid);
  loadCloud();
});

/* =====================
   STATE ACCESS
===================== */
function getState() {
  if (!window.gameState) return null;

  return {
    yellowMoney:
      gameState.yellowMoney ??
      gameState.yellowCoins ??
      window.yellowMoney ??
      0,

    ownedSkins: gameState.ownedSkins || [],
    selectedSkin: gameState.selectedSkin || "ball-green"
  };
}

function applyState(data) {
  if (!window.gameState || !data) return;

  if (data.yellowMoney !== undefined) {
    gameState.yellowMoney = data.yellowMoney;
    gameState.yellowCoins = data.yellowMoney;
    window.yellowMoney = data.yellowMoney;
  }

  if (data.ownedSkins) {
    gameState.ownedSkins = data.ownedSkins;
  }

  if (data.selectedSkin) {
    gameState.selectedSkin = data.selectedSkin;
  }

  console.log("â˜ï¸ Applied cloud state:", data);
}

/* =====================
   CLOUD SAVE
===================== */
async function saveCloud() {
  if (!currentUser) return;

  const state = getState();
  if (!state) return;

  try {
    await db.collection("users")
      .doc(currentUser.uid)
      .collection("games")
      .doc("greedySnakes")
      .set({
        ...state,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

    console.log("ðŸ’¾ Cloud saved", state);
  } catch (e) {
    console.warn("Save failed", e);
  }
}

/* =====================
   CLOUD LOAD
===================== */
async function loadCloud() {
  if (!currentUser) return;

  try {
    const snap = await db.collection("users")
      .doc(currentUser.uid)
      .collection("games")
      .doc("greedySnakes")
      .get();

    if (!snap.exists) return;

    applyState(snap.data());
  } catch (e) {
    console.warn("Load failed", e);
  }
}

/* =====================
   HARD RESET NA ELK POTJE
===================== */
function resetYellowMoney() {
  if (!window.gameState) return;

  gameState.yellowMoney = 0;
  gameState.yellowCoins = 0;
  window.yellowMoney = 0;

  console.log("ðŸ”„ Yellow money reset");
  saveCloud();
}

/* =====================
   START BUTTON HOOK
===================== */
const startHook = setInterval(() => {
  const btn = document.getElementById("startButton");
  if (!btn) return;

  btn.addEventListener("click", () => {
    setTimeout(resetYellowMoney, 500);
  });

  clearInterval(startHook);
}, 500);

/* =====================
   AUTO SAVE LOOP
===================== */
setInterval(saveCloud, 3000);

/* =====================
   SKINS TAB FIX
===================== */
const skinFix = setInterval(() => {
  const tab = document.querySelector(".skins-tab-indicator");
  if (!tab) return;

  tab.id = "skinsTab";
  clearInterval(skinFix);
}, 500);
</script>
