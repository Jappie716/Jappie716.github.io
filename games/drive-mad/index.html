<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Drive Mad - Real Cloud Sync</title>
  <link rel="stylesheet" href="webapp/fancade.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    #status { position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; padding: 8px 15px; border-radius: 20px; font-size: 13px; color: #00ff00; z-index: 9999; font-family: sans-serif; pointer-events: none; }
  </style>
</head>
<body id="body">
<div id="status">‚òÅÔ∏è Account check...</div>

<div id="canvas_border" class="emscripten_border">
  <canvas class="emscripten" id="canvas" tabindex="-1"></canvas>
</div>

<script>
const statusBox = document.getElementById("status");

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
  authDomain: "gameparadise-80490.firebaseapp.com",
  projectId: "gameparadise-80490",
  storageBucket: "gameparadise-80490.firebasestorage.app",
  messagingSenderId: "335620903527",
  appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let USER_ID = null;
let CLOUD_LEVEL = 1;
let CURRENT_GAME_LEVEL = 1;

// 1. LUISTER NAAR DE ENGINE (HOOK)
window.poki_level_start = function(level) {
    let lvl = (typeof level === "object") ? (level.level || 1) : level;
    lvl = Number(lvl);
    CURRENT_GAME_LEVEL = lvl;
    console.log("üïπÔ∏è Engine op Level:", lvl);

    // Sla op als we verder zijn gekomen
    if (USER_ID && lvl > CLOUD_LEVEL) {
        CLOUD_LEVEL = lvl;
        db.collection("drive_mad_saves").doc(USER_ID).set({
            lastLevel: lvl,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        statusBox.textContent = "üíæ Cloud Opgeslagen: Level " + lvl;
    }
};

// 2. DE "FORCE" TELEPORT (Zonder LocalStorage)
function forceTeleport() {
    if (CLOUD_LEVEL > 1) {
        const checkReady = setInterval(() => {
            // We checken of de engine functies beschikbaar zijn
            if (window.Module && typeof Module._poki_level_start === "function") {
                
                // Als de game nog op een lager level staat dan de cloud...
                if (CURRENT_GAME_LEVEL < CLOUD_LEVEL) {
                    console.log("üöÄ Cloud Push: Spring naar", CLOUD_LEVEL);
                    statusBox.textContent = "üöÄ Cloud Sync: Laden...";
                    
                    // Forceer de engine naar het cloud level
                    Module._poki_level_start(CLOUD_LEVEL);
                } else {
                    // We zijn er!
                    statusBox.textContent = "‚òÅÔ∏è Ingelogd: Level " + CLOUD_LEVEL;
                    clearInterval(checkReady);
                }
            }
        }, 1000); // Check elke seconde

        // Stop na 20 seconden (veiligheid)
        setTimeout(() => clearInterval(checkReady), 20000);
    }
}

// 3. AUTH & LOAD
auth.onAuthStateChanged(async (user) => {
    if (!user) {
        window.location.href = "index.html"; 
        return;
    }
    USER_ID = user.uid;
    console.log("üîê Ingelogd:", user.email);

    const doc = await db.collection("drive_mad_saves").doc(USER_ID).get();
    if (doc.exists) {
        CLOUD_LEVEL = Number(doc.data().lastLevel || 1);
        statusBox.textContent = "‚òÅÔ∏è Cloud gevonden: Level " + CLOUD_LEVEL;
        
        // Start de pusher zodra de data er is
        forceTeleport();
    } else {
        statusBox.textContent = "‚òÅÔ∏è Nieuw profiel: Level 1";
    }
});

var Module = {
    canvas: document.getElementById("canvas"),
    locateFile: (path) => "webapp/" + path,
    onRuntimeInitialized: () => { console.log("‚öôÔ∏è Engine Ready"); }
};

function hookPoki() {
  if (typeof window.poki_level_start === "function") {
    const original = window.poki_level_start;

    window.poki_level_start = function(level) {
      original(level); // laat de game normaal werken

      let lvl = (typeof level === "object") ? (level.level || 1) : level;
      lvl = Number(lvl);

      CURRENT_GAME_LEVEL = lvl;
      console.log("üïπÔ∏è Level hook:", lvl);

      if (USER_ID && lvl > CLOUD_LEVEL) {
        CLOUD_LEVEL = lvl;

        db.collection("drive_mad_saves").doc(USER_ID).set({
          lastLevel: lvl,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        statusBox.textContent = "üíæ Cloud: Level " + lvl;
      }
    };

    console.log("‚úÖ Poki hook gepatched");
    return true;
  }
  return false;
}

// blijf proberen tot engine geladen is
const hookInterval = setInterval(() => {
  if (hookPoki()) clearInterval(hookInterval);
}, 500);
</script>

<script src="webapp/source_min.js"></script>
<script src="webapp/index.js"></script>
</body>
</html>
