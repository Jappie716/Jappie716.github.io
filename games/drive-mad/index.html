<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <title>Drive Mad - Cloud Sync Fixed</title>
    <link rel="stylesheet" href="webapp/fancade.css" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        #cloudStatus {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); color: #0f0;
            font-family: monospace; font-size: 11px;
            padding: 12px; border-radius: 8px;
            z-index: 9999; border: 2px solid #0f0;
        }
        #syncBtn {
            margin-top: 8px; padding: 5px; background: #0f0; color: #000;
            border: none; cursor: pointer; width: 100%; font-weight: bold;
        }
        #loginBtn {
            position: fixed; top: 10px; left: 10px;
            z-index: 9999; padding: 10px 15px;
            background: #4285F4; color: white; border: none; cursor: pointer;
        }
    </style>
</head>
<body id="body">

<button id="loginBtn">üîê Inloggen</button>

<div id="cloudStatus">
    <div id="stats">Wachten op login...</div>
    <button id="syncBtn" style="display:none">NU SYNCHRONISEREN</button>
</div>

<div id="canvas_border" class="emscripten_border">
    <canvas class="emscripten" id="canvas" tabindex="-1"></canvas>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
    authDomain: "gameparadise-80490.firebaseapp.com",
    projectId: "gameparadise-80490",
    storageBucket: "gameparadise-80490.firebasestorage.app",
    messagingSenderId: "335620903527",
    appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let USER_ID = null;
let CLOUD_LEVEL = 1;
let CURRENT_GAME_LEVEL = 1;

const stats = document.getElementById("stats");
const syncBtn = document.getElementById("syncBtn");

// 1. Inloggen & Live Data
auth.onAuthStateChanged(async (user) => {
    if (user) {
        USER_ID = user.uid;
        document.getElementById("loginBtn").style.display = "none";
        syncBtn.style.display = "block";
        
        db.collection("drive_mad_saves").doc(USER_ID).onSnapshot(doc => {
            if (doc.exists) {
                CLOUD_LEVEL = Number(doc.data().lastLevel || 1);
                updateUI();
            }
        });
    }
});

document.getElementById("loginBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

function updateUI() {
    stats.innerHTML = `üë§ Ingelogd<br>‚òÅÔ∏è Cloud: Lvl ${CLOUD_LEVEL}<br>üïπÔ∏è Game: Lvl ${CURRENT_GAME_LEVEL}`;
}

// 2. De "Hamer" (Blijven proberen te teleporten)
function forceTeleport() {
    if (CLOUD_LEVEL > CURRENT_GAME_LEVEL) {
        console.log("üöÄ Poging tot teleport naar level", CLOUD_LEVEL);
        if (window.Module && typeof Module._poki_level_start === "function") {
            Module._poki_level_start(CLOUD_LEVEL);
        }
    }
}

// Check elke 2 seconden of we al op het cloud level zijn
const teleportTimer = setInterval(() => {
    if (USER_ID && CLOUD_LEVEL > CURRENT_GAME_LEVEL) {
        forceTeleport();
    } else if (USER_ID && CURRENT_GAME_LEVEL >= CLOUD_LEVEL && CLOUD_LEVEL > 1) {
        console.log("‚úÖ Sync voltooid");
        updateUI();
    }
}, 2000);

syncBtn.onclick = () => forceTeleport();

// 3. Level Detectie & Auto-Save
window.poki_level_start = function(data) {
    let lvl = (typeof data === "object") ? (data.level || 1) : Number(data);
    CURRENT_GAME_LEVEL = lvl;
    updateUI();

    // Sla op als we verder zijn
    if (USER_ID && lvl > CLOUD_LEVEL) {
        db.collection("drive_mad_saves").doc(USER_ID).set({
            lastLevel: lvl,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    }
};

var Module = {
    canvas: document.getElementById("canvas"),
    locateFile: (p) => "webapp/" + p
};
</script>

<script src="webapp/source_min.js"></script>
<script src="webapp/index.js"></script>

</body>
</html>
