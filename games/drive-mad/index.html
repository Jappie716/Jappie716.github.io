<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="utf-8" />
    <title>Drive Mad - Cloud Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="webapp/fancade.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body id="body">

<div id="status-overlay" style="position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.9); color:white; padding:10px; text-align:center; z-index:9999; font-family:sans-serif;">
    Laden...
</div>

<div id="canvas_border" class="emscripten_border">
    <canvas class="emscripten" id="canvas" tabindex="-1"></canvas>
</div>

<script>
    // 1. Firebase Configuratie
    const firebaseConfig = {
        apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
        authDomain: "gameparadise-80490.firebaseapp.com",
        projectId: "gameparadise-80490",
        storageBucket: "gameparadise-80490.firebasestorage.app",
        messagingSenderId: "335620903527",
        appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Globale variabelen (gebruik window. om 'already declared' te voorkomen)
    window.TARGET_LEVEL = 1;
    window.CURRENT_LEVEL = 0;
    window.USER_ID = null;

    // 2. Functie om level te laden uit Firebase
    async function syncFromCloud() {
        if (!window.USER_ID) return;
        try {
            const doc = await db.collection("drive_mad_saves").doc(window.USER_ID).get();
            if (doc.exists) {
                window.TARGET_LEVEL = Number(doc.data().lastLevel || 1);
                console.log("üéØ Cloud Target Level:", window.TARGET_LEVEL);
            }
        } catch (e) {
            console.error("‚ùå Cloud laden mislukt:", e);
        }
    }

    // 3. Functie om level op te slaan
    async function syncToCloud(level) {
        if (!window.USER_ID || level <= window.CURRENT_LEVEL) return;
        try {
            await db.collection("drive_mad_saves").doc(window.USER_ID).set({
                lastLevel: level,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            console.log("üíæ Opgeslagen naar cloud: Level", level);
        } catch (e) {
            console.warn("‚ùå Opslaan mislukt:", e);
        }
    }

    // 4. De Game Hook (zorgt voor het overslaan van levels)
    const originalPokiStart = window.poki_level_start;
    window.poki_level_start = function(level) {
        window.CURRENT_LEVEL = level;
        console.log("üéÆ Game start level:", level);

        // Opslaan als we een nieuw level bereiken
        syncToCloud(level);

        // Overslaan logica
        if (window.CURRENT_LEVEL < window.TARGET_LEVEL) {
            console.log("‚è© Overslaan naar:", window.CURRENT_LEVEL + 1);
            setTimeout(() => {
                if (typeof originalPokiStart === "function") {
                    originalPokiStart(window.CURRENT_LEVEL + 1);
                }
            }, 150);
            return;
        }

        if (typeof originalPokiStart === "function") {
            originalPokiStart(level);
        }
    };

    // 5. Opstarten
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            window.USER_ID = user.uid;
            document.getElementById('status-overlay').innerText = "Data synchroniseren...";
            await syncFromCloud();
            document.getElementById('status-overlay').style.display = "none";
        } else {
            window.location.href = "index.html"; // Terug naar login als niet ingelogd
        }
    });

    // Emscripten Module Setup
    var Module = {
        canvas: document.getElementById("canvas"),
        locateFile: function(path) { return "webapp/" + path; },
        setStatus: function(text) { 
            if (!text) return;
            console.log("Engine:", text);
        }
    };
</script>

<script src="webapp/source_min.js"></script>
<script src="webapp/index.js"></script>

</body>
</html>
