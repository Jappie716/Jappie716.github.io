<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <title>Drive Mad - Ultimate Cloud Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="webapp/fancade.css" />
    <link rel="icon" href="webapp/cover.jpg" />

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        #cloudStatus {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); color: #0f0;
            font-family: monospace; font-size: 11px;
            padding: 10px; border-radius: 5px;
            z-index: 9999; border: 1px solid #0f0;
            pointer-events: none; line-height: 1.4;
        }
        #loginBtn {
            position: fixed; top: 10px; left: 10px;
            z-index: 9999; padding: 10px 15px;
            background: #4285F4; color: white;
            border: none; cursor: pointer; border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>

<body id="body">

<button id="loginBtn">üîê Google Login</button>
<div id="cloudStatus">Wachten op systeem...</div>

<div id="modal_parent">
    <div id="modal_content">
        <span id="modal_close_button">&times;</span>
        <div id="store_link_modal_content" class="modal_inner"></div>
        <div id="share_file_modal_content" class="modal_inner"></div>
    </div>
</div>

<div id="canvas_border" class="emscripten_border">
    <div id="play_content" class="middle center">
        <div class="edge"><div class="box"><div class="black">
            <img src="webapp/cover.jpg" class="cover" />
            <p class="title">Drive Mad</p>
            <p class="author">Martin Magni</p>
        </div></div></div>
        <div id="progress_or_play"><progress id="progress" class="loading" value="0" max="100"></progress></div>
    </div>
    <canvas class="emscripten" id="canvas" tabindex="-1"></canvas>
    <div id="gradient"></div>
    <div id="webview_content"></div>
</div>

<script>
/* ==========================
   üî• FIREBASE LIVE CONNECT
========================== */
const firebaseConfig = {
    apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
    authDomain: "gameparadise-80490.firebaseapp.com",
    projectId: "gameparadise-80490",
    storageBucket: "gameparadise-80490.firebasestorage.app",
    messagingSenderId: "335620903527",
    appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let USER_ID = null;
let CLOUD_LEVEL = 1;
let CURRENT_GAME_LEVEL = 1;
let TELEPORT_SUCCESS = false;

const status = (msg) => { document.getElementById("cloudStatus").innerHTML = msg; };

// üîê Login
document.getElementById("loginBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

// üì° LIVE VERBINDING (onSnapshot)
auth.onAuthStateChanged(user => {
    if (user) {
        USER_ID = user.uid;
        document.getElementById("loginBtn").style.display = "none";
        
        // Luister live naar de database
        db.collection("drive_mad_saves").doc(USER_ID).onSnapshot(doc => {
            if (doc.exists) {
                CLOUD_LEVEL = doc.data().lastLevel || 1;
                status(`üë§ ${user.email.split('@')[0]}<br>‚òÅÔ∏è Cloud Lvl: ${CLOUD_LEVEL}<br>üïπÔ∏è Game Lvl: ${CURRENT_GAME_LEVEL}`);
            }
        });
    } else {
        status("‚ö†Ô∏è Log in voor cloud sync");
    }
});

/* ==========================
   üïπÔ∏è ENGINE CONTROL
========================== */

// Vang elk nieuw level op
window.poki_level_start = function(data) {
    const lvl = (typeof data === "object") ? (data.level || 1) : Number(data);
    CURRENT_GAME_LEVEL = lvl;
    console.log("Game naar level:", lvl);
};

// üíæ OPSLAAN: Elke 10 seconden (agressiever)
setInterval(() => {
    if (USER_ID && CURRENT_GAME_LEVEL > CLOUD_LEVEL) {
        db.collection("drive_mad_saves").doc(USER_ID).set({
            lastLevel: CURRENT_GAME_LEVEL,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(() => {
            console.log("Save succesvol!");
        });
    }
}, 10000);

// üöÄ TELEPORT: De "Hamer" methode
// We blijven proberen te teleporten totdat CURRENT_GAME_LEVEL gelijk is aan CLOUD_LEVEL
const forcer = setInterval(() => {
    if (USER_ID && CLOUD_LEVEL > 1 && !TELEPORT_SUCCESS) {
        if (window.Module && typeof Module._poki_level_start === "function") {
            
            if (CURRENT_GAME_LEVEL < CLOUD_LEVEL) {
                console.log("Forceer teleport naar", CLOUD_LEVEL);
                status(`üöÄ Synchroniseren...<br>Spring naar level ${CLOUD_LEVEL}`);
                Module._poki_level_start(CLOUD_LEVEL);
            } else {
                TELEPORT_SUCCESS = true;
                status(`‚úÖ In sync op Lvl ${CLOUD_LEVEL}`);
                clearInterval(forcer);
            }
        }
    }
}, 1500);

// Stop de forcer na 45 seconden om oneindige loops te voorkomen
setTimeout(() => clearInterval(forcer), 45000);

var Module = {
    canvas: document.getElementById("canvas"),
    locateFile: (p) => "webapp/" + p
};
</script>

<script src="webapp/source_min.js"></script>
<script src="webapp/index.js"></script>

</body>
</html>
