<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Drive Mad - Cloud Save</title>

  <script type="text/javascript" src="Jump_Gamemonetize.js"></script>
  <script src="/js/main.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="webapp/fancade.css" />
  <link rel="icon" href="webapp/cover.jpg" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    #cloudStatus {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      border-radius: 6px;
      z-index: 9999;
      min-width: 220px;
    }

    #loginBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 8px 12px;
      background: #222;
      color: white;
      border: 1px solid #555;
      cursor: pointer;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>

<body id="body">

  <!-- LOGIN BUTTON -->
  <button id="loginBtn">ğŸ” Login met Google</button>

  <!-- STATUS BOX -->
  <div id="cloudStatus">
    ğŸ“¡ Initialiseren...
  </div>

  <div id="modal_parent">
    <div id="modal_content">
      <span id="modal_close_button">&times;</span>
      <div id="store_link_modal_content" class="modal_inner"></div>
      <div id="share_file_modal_content" class="modal_inner"></div>
    </div>
  </div>

  <div id="canvas_border" class="emscripten_border">
    <div id="play_content" class="middle center">
      <div class="edge">
        <div class="box">
          <div class="black">
            <img src="webapp/cover.jpg" class="cover" />
            <p class="title">Drive Mad</p>
            <p class="author">Martin Magni</p>
          </div>
        </div>
      </div>
      <div id="progress_or_play">
        <progress id="progress" class="loading" value="0" max="100"></progress>
      </div>
      <p class="description"></p>
    </div>

    <canvas class="emscripten" id="canvas" tabindex="-1"></canvas>
    <div id="gradient"></div>
    <div id="webview_content"></div>
  </div>

  <script type="text/javascript" src="webapp/source_min.js"></script>
  <script type="text/javascript" src="webapp/index.js"></script>

  <script>
    // ğŸ”‘ FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
      authDomain: "gameparadise-80490.firebaseapp.com",
      projectId: "gameparadise-80490",
      storageBucket: "gameparadise-80490.firebasestorage.app",
      messagingSenderId: "335620903527",
      appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const statusBox = document.getElementById("cloudStatus");
    const loginBtn = document.getElementById("loginBtn");

    let user = null;
    let cloudLevel = 1;
    let teleported = false;
    let engineReady = false;
    let lastKnownLevel = 1;

    function setStatus(text) {
      statusBox.innerHTML = text;
    }

    // ğŸ” LOGIN
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        setStatus("âŒ Login fout<br>" + err.message);
      });
    };

    // ğŸ” AUTH LISTENER
    auth.onAuthStateChanged(async (u) => {
      if (!u) {
        user = null;
        setStatus("âš ï¸ Niet ingelogd");
        return;
      }

      user = u;
      loginBtn.style.display = "none";
      setStatus("ğŸ” Ingelogd:<br>" + user.email + "<br>â˜ï¸ Cloud laden...");

      await loadCloudLevel();
    });

    // â˜ï¸ CLOUD LOAD
    async function loadCloudLevel() {
      try {
        const ref = db.collection("drive_mad_saves").doc(user.uid);
        const snap = await ref.get();

        if (snap.exists) {
          cloudLevel = snap.data().lastLevel || 1;
        } else {
          cloudLevel = 1;
          await ref.set({
            lastLevel: 1,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        setStatus(
          "ğŸ” Ingelogd:<br>" + user.email +
          "<br>â˜ï¸ Cloud level: " + cloudLevel
        );
      } catch (e) {
        setStatus("âŒ Cloud fout<br>" + e.message);
      }
    }

    // ğŸ•¹ï¸ ENGINE READY CHECK
    const engineCheck = setInterval(() => {
      if (typeof Module !== "undefined" && Module.ccall) {
        engineReady = true;
        clearInterval(engineCheck);
        hookEngine();
      }
    }, 500);

    // ğŸª ENGINE HOOK
    function hookEngine() {
      if (!Module.ccall) return;

      const originalCall = Module.ccall;

      Module.ccall = function (func, returnType, argTypes, args) {
        try {
          if (func === "poki_level_start") {
            const newLevel = parseInt(args[0]);

            if (!isNaN(newLevel)) {
              onLevelChange(newLevel);
            }
          }
        } catch (e) {
          console.warn("Cloud hook error:", e);
        }

        return originalCall.apply(this, arguments);
      };

      setStatus(prevStatus() + "<br>ğŸ“¡ Engine gekoppeld");
      autoTeleport();
    }

    function prevStatus() {
      return statusBox.innerHTML;
    }

    // ğŸš€ TELEPORT
    function autoTeleport() {
      if (!user) return;
      if (teleported) return;
      if (!engineReady) return;
      if (cloudLevel <= 1) return;

      teleported = true;

      setStatus(prevStatus() + "<br>ğŸš€ Spring naar level " + cloudLevel);

      try {
        Module.ccall("poki_level_start", null, ["number"], [cloudLevel]);
      } catch (e) {
        console.warn("Teleport failed:", e);
      }
    }

    // ğŸ’¾ SAVE LOGIC
    async function onLevelChange(newLevel) {
      lastKnownLevel = newLevel;

      if (!user) return;
      if (newLevel <= cloudLevel) return;

      cloudLevel = newLevel;

      setStatus(prevStatus() + "<br>ğŸ’¾ Opslaan: Level " + newLevel);

      try {
        await db.collection("drive_mad_saves").doc(user.uid).set({
          lastLevel: newLevel,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        setStatus(prevStatus() + "<br>âŒ Opslaan mislukt");
      }
    }
  </script>

</body>
</html>
