<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ragdoll Archers - Game Paradise</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/styyyle.css">
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
    </div>
    <div id="loading-cover">
        <div id="unity-loading-bar">
            <div id="unity-logo"><img src="logo.jpeg"></div>
            <div class="progress-spinner-container">
                <div class="spinner-left"><img src="spinner.png"></div>
                <div id="unity-progress-bar-empty">
                    <div id="unity-progress-bar-full"></div>
                </div>
                <div class="spinner-right"><img src="spinner.png"></div>
            </div>
        </div>
    </div>

    <script>
// --- 1. FIREBASE INITIALISATIE (Blijft hetzelfde) ---
const firebaseConfig = {
    apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
    authDomain: "gameparadise-80490.firebaseapp.com",
    projectId: "gameparadise-80490",
    storageBucket: "gameparadise-80490.firebasestorage.app",
    messagingSenderId: "335620903527",
    appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// --- 2. INDEXEDDB HELPER FUNCTIES ---
// Deze functie haalt de 'echte' save-data uit de verborgen Unity database
async function getUnitySaveData() {
    return new Promise((resolve) => {
        const request = indexedDB.open("/idbfs"); // De standaard Unity database naam
        request.onerror = () => resolve({});
        request.onsuccess = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("FILE_DATA")) return resolve({});
            
            const transaction = db.transaction(["FILE_DATA"], "readonly");
            const store = transaction.objectStore("FILE_DATA");
            const getAllRequest = store.getAll();
            const getAllKeysRequest = store.getAllKeys();

            getAllRequest.onsuccess = () => {
                const results = {};
                const keys = getAllKeysRequest.result;
                const values = getAllRequest.result;
                keys.forEach((key, i) => {
                    // We converteren de data naar een leesbaar formaat voor Firebase
                    results[key.replace(/\//g, '_')] = Array.from(values[i].contents);
                });
                resolve(results);
            };
        };
    });
}

async function restoreUnitySaveData(data) {
    return new Promise((resolve) => {
        const request = indexedDB.open("/idbfs");
        request.onsuccess = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("FILE_DATA")) return resolve();
            
            const transaction = db.transaction(["FILE_DATA"], "readwrite");
            const store = transaction.objectStore("FILE_DATA");
            
            for (const key in data) {
                const originalKey = key.replace(/_/g, '/');
                const uint8Array = new Uint8Array(data[key]);
                store.put({ contents: uint8Array, timestamp: new Date() }, originalKey);
            }
            transaction.oncomplete = () => resolve();
        };
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            db.createObjectStore("FILE_DATA");
        };
    });
}

// --- 3. AANGEPASTE SAVE & LOAD ---
async function saveToCloud() {
    const user = auth.currentUser;
    if (!user) return;

    const gameData = await getUnitySaveData();
    
    // Als de gameData leeg is, proberen we als backup toch even localStorage
    const backupData = {};
    if (Object.keys(gameData).length === 0) {
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k.startsWith('firebase:')) backupData[k] = localStorage.getItem(k);
        }
    }

    try {
        await db.collection("users").doc(user.uid)
                .collection("saveData").doc("Ragdoll-Archers")
                .set({
                    unityData: gameData,
                    localBackup: backupData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        console.log("✅ Cloud Save Sync voltooid");
    } catch (e) {
        console.error("❌ Save fout:", e);
    }
}

async function loadFromCloud() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const doc = await db.collection("users").doc(user.uid)
                           .collection("saveData").doc("Ragdoll-Archers").get();
        
        if (doc.exists) {
            const data = doc.data();
            if (data.unityData) await restoreUnitySaveData(data.unityData);
            if (data.localBackup) {
                for (const key in data.localBackup) localStorage.setItem(key, data.localBackup[key]);
            }
            console.log("✅ Cloud Load Sync voltooid");
        }
    } catch (e) {
        console.error("❌ Load fout:", e);
    }
}

// --- 4. START LOGICA ---
auth.onAuthStateChanged(async (user) => {
    if (!user) return;

    await loadFromCloud();

    const config = {
        dataUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/6697b6deba8b617c67b69c55dcd07cb1.data.unityweb",
        frameworkUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/0be3c3ee7115b26e1ae28e643afdf1f2.js.unityweb",
        codeUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/b3397c29f6878557c1c614cbf9e196ea.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Ericetto",
        productName: "Ragdoll Archers",
        productVersion: "0.1",
    };

    const loaderUrl = "https://cdn.jsdelivr.net/gh/bubbls/ruffle@7117cc5006472d782b65d96abd375597d6273242/v11121212.js";
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
        createUnityInstance(document.querySelector("#unity-canvas"), config, (progress) => {
            document.querySelector("#unity-progress-bar-full").style.width = (100 * progress) + "%";
        }).then((instance) => {
            document.querySelector("#loading-cover").style.display = "none";
            setInterval(saveToCloud, 30000); // Elke 30 seconden synchroniseren
        });
    };
    document.body.appendChild(script);
});
    </script>
</body>
</html>
