<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ragdoll Archers - Game Paradise</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/styyyle.css">
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
    </div>
    <div id="loading-cover">
        <div id="unity-loading-bar">
            <div id="unity-logo"><img src="logo.jpeg"></div>
            <div class="progress-spinner-container">
                <div class="spinner-left"><img src="spinner.png"></div>
                <div id="unity-progress-bar-empty">
                    <div id="unity-progress-bar-full"></div>
                </div>
                <div class="spinner-right"><img src="spinner.png"></div>
            </div>
        </div>
    </div>

    <script>
/// --- 1. FIREBASE INITIALISATIE ---
const firebaseConfig = {
    apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
    authDomain: "gameparadise-80490.firebaseapp.com",
    projectId: "gameparadise-80490",
    storageBucket: "gameparadise-80490.firebasestorage.app",
    messagingSenderId: "335620903527",
    appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// --- 2. VERBETERDE DATABASE SCRAPER ---
async function getUnitySaveData() {
    return new Promise(async (resolve) => {
        // We proberen de meest voorkomende namen voor Unity databases
        const dbNames = ["/idbfs", "UnityCache", "Ragdoll Archers"]; 
        let foundData = {};

        for (const name of dbNames) {
            try {
                const results = await new Promise((res) => {
                    const req = indexedDB.open(name);
                    req.onsuccess = (e) => {
                        const idb = e.target.result;
                        // Als de database geen 'FILE_DATA' heeft, proberen we de volgende
                        if (!idb.objectStoreNames.contains("FILE_DATA")) {
                            idb.close();
                            return res(null);
                        }
                        
                        const tx = idb.transaction(["FILE_DATA"], "readonly");
                        const store = tx.objectStore("FILE_DATA");
                        const getKeys = store.getAllKeys();
                        const getVals = store.getAll();

                        getVals.onsuccess = () => {
                            let data = {};
                            getKeys.result.forEach((key, i) => {
                                if (getVals.result[i].contents) {
                                    data[key.replace(/\//g, '_')] = Array.from(getVals.result[i].contents);
                                }
                            });
                            idb.close();
                            res(data);
                        };
                    };
                    req.onerror = () => res(null);
                });
                if (results && Object.keys(results).length > 0) {
                    foundData = results;
                    console.log(`‚úÖ Data gevonden in database: ${name}`);
                    break;
                }
            } catch (err) { console.log(`Database ${name} niet gevonden.`); }
        }
        resolve(foundData);
    });
}

// --- 3. SAVE FUNCTIE MET CONSOLE LOGS ---
async function saveToCloud() {
    const user = auth.currentUser;
    if (!user) return;

    console.log("‚è≥ Bezig met verzamelen van game data...");
    const gameData = await getUnitySaveData();

    if (Object.keys(gameData).length === 0) {
        console.warn("‚ö†Ô∏è Geen game data gevonden in IndexedDB. Heeft de game al iets opgeslagen?");
        return;
    }

    try {
        await db.collection("users").doc(user.uid)
                .collection("saveData").doc("Ragdoll-Archers")
                .set({
                    unityData: gameData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        console.log("üöÄ Firebase is succesvol bijgewerkt!");
    } catch (e) {
        console.error("‚ùå Firebase fout:", e);
    }
}
    </script>
</body>
</html>
