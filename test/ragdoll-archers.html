<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ragdoll Archers - Game Paradise</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/styyyle.css">
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
    </div>
    <div id="loading-cover">
        <div id="unity-loading-bar">
            <div id="unity-logo"><img src="logo.jpeg"></div>
            <div class="progress-spinner-container">
                <div class="spinner-left"><img src="spinner.png"></div>
                <div id="unity-progress-bar-empty">
                    <div id="unity-progress-bar-full"></div>
                </div>
                <div class="spinner-right"><img src="spinner.png"></div>
            </div>
        </div>
    </div>

    <script>
// --- 1. FIREBASE INITIALISATIE ---
const firebaseConfig = {
    apiKey: "AIzaSyA0K4geAuueVfiItB_98-LkqRTnpYNUNvM",
    authDomain: "gameparadise-80490.firebaseapp.com",
    projectId: "gameparadise-80490",
    storageBucket: "gameparadise-80490.firebasestorage.app",
    messagingSenderId: "335620903527",
    appId: "1:335620903527:web:1bc1e01a386bf6e4e7fac2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let unityInstance = null;

// --- 2. DE "SAVE" FUNCTIE (VERBETERD) ---
async function saveToCloud() {
    const user = auth.currentUser;
    if (!user) {
        console.warn("Niet opgeslagen: Gebruiker niet ingelogd.");
        return;
    }

    // Pak alle localStorage data (voor de zekerheid)
    const localData = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        localData[key] = localStorage.getItem(key);
    }

    try {
        // We slaan het op in het pad dat jij wilde
        await db.collection("users").doc(user.uid)
                .collection("saveData").doc("Ragdoll-Archers")
                .set({
                    allLocalStorage: localData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    info: "Auto-save van Unity Game"
                }, { merge: true });
        
        console.log("✅ Succesvol opgeslagen in Firebase!");
    } catch (e) {
        console.error("❌ Firebase Save Fout:", e);
    }
}

// --- 3. GAME LADEN & AUTH ---
const container = document.querySelector("#unity-container");
const canvas = document.querySelector("#unity-canvas");
const loadingCover = document.querySelector("#loading-cover");
const progressBarFull = document.querySelector("#unity-progress-bar-full");

const config = {
    dataUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/6697b6deba8b617c67b69c55dcd07cb1.data.unityweb",
    frameworkUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/0be3c3ee7115b26e1ae28e643afdf1f2.js.unityweb",
    codeUrl: "https://cdn.jsdelivr.net/gh/bubbls/ruffle@04dd5345a30d6ebf4b0e2cc385568750cd56ed5a/b3397c29f6878557c1c614cbf9e196ea.wasm.unityweb",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "Ericetto",
    productName: "Ragdoll Archers",
    productVersion: "0.1",
};

auth.onAuthStateChanged((user) => {
    if (!user) {
        alert("Log eerst in om je voortgang op te slaan!");
        return;
    }

    // Start Unity pas als we weten wie de gebruiker is
    const loaderUrl = "https://cdn.jsdelivr.net/gh/bubbls/ruffle@7117cc5006472d782b65d96abd375597d6273242/v11121212.js";
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
            progressBarFull.style.width = (100 * progress) + "%";
        }).then((instance) => {
            unityInstance = instance;
            loadingCover.style.display = "none";
            
            // Start de auto-save loop
            console.log("Auto-save geactiveerd...");
            setInterval(saveToCloud, 20000); // Elke 20 sec
        });
    };
    document.body.appendChild(script);
});

// Forceer save bij afsluiten
window.onbeforeunload = () => { saveToCloud(); };

    </script>
</body>
</html>
